import{ae as H,x as n,ar as J,ag as $,as as O,c as l,ai as o,au as G,ac as Q,ao as W,J as x,am as v,al as L,aM as X,V as Y,ah as Z,at as ee,ax as N,aj as s,ak as ae,ay as le,az as te,aB as oe,aE as se,aw as re,an as ne,a6 as ue}from"./index-2a6e0187.js";import{c as ie,a as R,f as de,u as me,d as F,V as ce}from"./index.esm-ffca95e4.js";import{a as ve,V as M}from"./VCol-ba6d81c5.js";import{V as pe}from"./VRow-1fd3371c.js";import{V as ge}from"./VDivider-303ab244.js";import{V as fe,a as Ve,b as be}from"./VTextarea-6458ace2.js";import"./VDataTable-6273f966.js";import"./VList-581bf7ed.js";const ye=ne("h1",{class:"text-center"},"貼文管理",-1),Fe={__name:"MyPosts",setup(ke){const{apiAuth:w}=W(),C=H(),U=n(null),p=n(!1),d=n(""),D=r=>{r?(d.value=r._id,g.value.value=r.title,f.value.value=r.content,V.value.value=r.release):d.value="",p.value=!0},I=()=>{for(p.value=!1,q();u.value.length>0;)U.value.deleteFileRecord(u.value[0])},z=ie({title:R().required("缺少貼文標題"),content:R().required("缺少貼文內容"),release:de()}),{handleSubmit:j,isSubmitting:h,resetForm:q}=me({validationSchema:z,initialValues:{title:"",content:"",release:!1}}),g=F("title"),f=F("content"),V=F("release"),u=n([]),T=n([]),E=j(async r=>{var a,m,e;if(!((a=u.value[0])!=null&&a.error)&&!(d.value===""&&u.value.length===0))try{const t=new FormData;for(const i in r)t.append(i,r[i]);if(u.value.length>0)for(const i of u.value)t.append("image",i.file);d.value===""?await w.post("/posts",t):await w.patch("/posts/"+d.value,t),C({text:d.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),I(),P()}catch(t){console.log(t);const i=((e=(m=t==null?void 0:t.response)==null?void 0:m.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";C({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),B=n(10),b=n([{key:"createdAt",order:"desc"}]),y=n(1),A=n([]),K=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"標題",align:"center",sortable:!1,key:"title"},{title:"發佈",align:"center",sortable:!0,key:"release"},{title:"發佈時間",align:"center",sortable:!0,key:"createdAt"},{title:"編輯",align:"center",sortable:!1,key:"edit"}],S=n(!0),_=n(0),k=n(""),c=async()=>{var r,a,m,e;S.value=!0;try{const{data:t}=await w.get("/posts/all",{params:{page:y.value,itemsPerPage:B.value,sortBy:((r=b.value[0])==null?void 0:r.key)||"createdAt",sortOrder:((a=b.value[0])==null?void 0:a.order)==="asc"?1:-1,search:k.value}});A.value.splice(0,A.value.length,...t.result.data),_.value=t.result.total}catch(t){console.log(t);const i=((e=(m=t==null?void 0:t.response)==null?void 0:m.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";C({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}S.value=!1};c();const P=()=>{y.value=1,c()};return(r,a)=>{const m=J("VueFileAgent");return $(),O(Q,null,[l(ve,null,{default:o(()=>[l(pe,null,{default:o(()=>[l(M,{cols:"12"},{default:o(()=>[ye]),_:1}),l(ge),l(M,{cols:"12"},{default:o(()=>[l(x,{color:"green",onClick:a[0]||(a[0]=e=>D())},{default:o(()=>[v("新增貼文")]),_:1}),l(M,{cols:"12"}),l(fe,{"items-per-page":B.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>B.value=e),c],"sort-by":b.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>b.value=e),c],page:y.value,"onUpdate:page":[a[4]||(a[4]=e=>y.value=e),c],items:A.value,headers:K,loading:S.value,"items-length":_.value,search:k.value,hover:""},{top:o(()=>[l(L,{label:"搜尋","append-icon":"mdi-magnify",modelValue:k.value,"onUpdate:modelValue":a[1]||(a[1]=e=>k.value=e),"onClick:append":P,onKeydown:X(P,["enter"])},null,8,["modelValue"])]),"item.image":o(({item:e})=>[l(Y,{src:e.image[0],height:"50px"},null,8,["src"])]),"item.release":o(({item:e})=>[e.release?($(),Z(ue,{key:0,icon:"mdi-check"})):ee("",!0)]),"item.createdAt":o(({item:e})=>[v(N(new Date(e.createdAt).toLocaleString()),1)]),"item.edit":o(({item:e})=>[l(x,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:t=>D(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),l(G,{modelValue:p.value,"onUpdate:modelValue":a[10]||(a[10]=e=>p.value=e),persistent:"",width:"500px"},{default:o(()=>[l(ce,{disabled:s(h),onSubmit:ae(s(E),["prevent"])},{default:o(()=>[l(le,null,{default:o(()=>[l(te,null,{default:o(()=>[v(N(d.value===""?"新增貼文":"編輯貼文"),1)]),_:1}),l(oe,null,{default:o(()=>[l(L,{label:"標題",modelValue:s(g).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>s(g).value.value=e),"error-messages":s(g).errorMessage.value},null,8,["modelValue","error-messages"]),l(Ve,{label:"發佈",modelValue:s(V).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>s(V).value.value=e),"error-messages":s(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(be,{label:"內容",modelValue:s(f).value.value,"onUpdate:modelValue":a[7]||(a[7]=e=>s(f).value.value=e),"error-messages":s(f).errorMessage.value},null,8,["modelValue","error-messages"]),l(m,{modelValue:u.value,"onUpdate:modelValue":a[8]||(a[8]=e=>u.value=e),rawModelValue:T.value,"onUpdate:rawModelValue":a[9]||(a[9]=e=>T.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":5,multiple:"","max-size":"1MB",ref_key:"fileAgent",ref:U},null,8,["modelValue","rawModelValue"])]),_:1}),l(se,null,{default:o(()=>[l(re),l(x,{color:"red",disabled:s(h),onClick:I},{default:o(()=>[v("取消")]),_:1},8,["disabled"]),l(x,{color:"green",type:"submit",loading:s(h)},{default:o(()=>[v("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{Fe as default};
