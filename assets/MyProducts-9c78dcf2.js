import{ae as G,x as u,ar as Q,ag as E,as as W,c as l,ai as s,au as X,ac as Y,ao as Z,J as B,am as p,al as D,aM as ee,V as ae,ah as le,at as te,ax as j,aj as t,ak as oe,ay as se,az as re,aB as ue,aE as ne,aw as ie,an as de,a6 as me}from"./index-2a6e0187.js";import{c as ce,a as I,e as pe,f as ve,u as ge,d as v,V as Ve}from"./index.esm-ffca95e4.js";import{a as fe,V as T}from"./VCol-ba6d81c5.js";import{V as be}from"./VRow-1fd3371c.js";import{V as ye}from"./VDivider-303ab244.js";import{V as ke,a as xe,b as we}from"./VTextarea-6458ace2.js";import{V as Ce}from"./VDataTable-6273f966.js";import"./VList-581bf7ed.js";const Be=de("h1",{class:"text-center"},"商品管理",-1),Te={__name:"MyProducts",setup(Se){const{apiAuth:S}=Z(),A=G(),$=u(null),g=u(!1),d=u(""),q=r=>{r?(d.value=r._id,V.value.value=r.name,f.value.value=r.price,b.value.value=r.description,y.value.value=r.category,k.value.value=r.sell):d.value="",g.value=!0},L=()=>{for(g.value=!1,H();n.value.length>0;)$.value.deleteFileRecord(n.value[0])},N=["營地轉讓","露營裝備"],K=ce({name:I().required("缺少商品名稱"),price:pe().typeError("商品價格格式錯誤").required("缺少商品價格").min(0,"商品價格不能小於 0"),description:I().required("缺少商品說明"),category:I().required("缺少商品分類").test("isCategory","商品分類錯誤",r=>N.includes(r)),sell:ve()}),{handleSubmit:_,isSubmitting:M,resetForm:H}=ge({validationSchema:K,initialValues:{name:"",price:0,description:"",category:"",sell:!1}}),V=v("name"),f=v("price"),b=v("description"),y=v("category"),k=v("sell"),n=u([]),R=u([]),J=_(async r=>{var a,m,e;if(!((a=n.value[0])!=null&&a.error)&&!(d.value===""&&n.value.length===0))try{const o=new FormData;for(const i in r)o.append(i,r[i]);if(n.value.length>0)for(const i of n.value)o.append("image",i.file);d.value===""?await S.post("/products",o):await S.patch("/products/"+d.value,o),A({text:d.value===""?"新增成功":"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),L(),F()}catch(o){console.log(o);const i=((e=(m=o==null?void 0:o.response)==null?void 0:m.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";A({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),h=u(10),x=u([{key:"createdAt",order:"desc"}]),w=u(1),P=u([]),O=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"名稱",align:"center",sortable:!0,key:"name"},{title:"價格",align:"center",sortable:!0,key:"price"},{title:"分類",align:"center",sortable:!0,key:"category"},{title:"上架",align:"center",sortable:!0,key:"sell"},{title:"上架時間",align:"center",sortable:!0,key:"createdAt"},{title:"編輯",align:"center",sortable:!1,key:"edit"}],U=u(!0),z=u(0),C=u(""),c=async()=>{var r,a,m,e;U.value=!0;try{const{data:o}=await S.get("/products/all",{params:{page:w.value,itemsPerPage:h.value,sortBy:((r=x.value[0])==null?void 0:r.key)||"createdAt",sortOrder:((a=x.value[0])==null?void 0:a.order)==="asc"?1:-1,search:C.value}});P.value.splice(0,P.value.length,...o.result.data),z.value=o.result.total}catch(o){console.log(o);const i=((e=(m=o==null?void 0:o.response)==null?void 0:m.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";A({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}U.value=!1};c();const F=()=>{w.value=1,c()};return(r,a)=>{const m=Q("VueFileAgent");return E(),W(Y,null,[l(fe,null,{default:s(()=>[l(be,null,{default:s(()=>[l(T,{cols:"12"},{default:s(()=>[Be]),_:1}),l(ye),l(T,{cols:"12"},{default:s(()=>[l(B,{color:"green",onClick:a[0]||(a[0]=e=>q())},{default:s(()=>[p("新增商品")]),_:1}),l(T,{cols:"12"}),l(ke,{"items-per-page":h.value,"onUpdate:itemsPerPage":[a[2]||(a[2]=e=>h.value=e),c],"sort-by":x.value,"onUpdate:sortBy":[a[3]||(a[3]=e=>x.value=e),c],page:w.value,"onUpdate:page":[a[4]||(a[4]=e=>w.value=e),c],items:P.value,headers:O,loading:U.value,"items-length":z.value,search:C.value,hover:""},{top:s(()=>[l(D,{label:"搜尋","append-icon":"mdi-magnify",modelValue:C.value,"onUpdate:modelValue":a[1]||(a[1]=e=>C.value=e),"onClick:append":F,onKeydown:ee(F,["enter"])},null,8,["modelValue"])]),"item.image":s(({item:e})=>[l(ae,{src:e.image[0],height:"50px"},null,8,["src"])]),"item.sell":s(({item:e})=>[e.sell?(E(),le(me,{key:0,icon:"mdi-check"})):te("",!0)]),"item.createdAt":s(({item:e})=>[p(j(new Date(e.createdAt).toLocaleString()),1)]),"item.edit":s(({item:e})=>[l(B,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:o=>q(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),l(X,{modelValue:g.value,"onUpdate:modelValue":a[12]||(a[12]=e=>g.value=e),persistent:"",width:"500px"},{default:s(()=>[l(Ve,{disabled:t(M),onSubmit:oe(t(J),["prevent"])},{default:s(()=>[l(se,null,{default:s(()=>[l(re,null,{default:s(()=>[p(j(d.value===""?"新增商品":"編輯商品"),1)]),_:1}),l(ue,null,{default:s(()=>[l(D,{label:"名稱",modelValue:t(V).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>t(V).value.value=e),"error-messages":t(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(D,{label:"價格",type:"number",min:"0",modelValue:t(f).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>t(f).value.value=e),"error-messages":t(f).errorMessage.value},null,8,["modelValue","error-messages"]),l(Ce,{label:"分類",items:N,modelValue:t(y).value.value,"onUpdate:modelValue":a[7]||(a[7]=e=>t(y).value.value=e),"error-messages":t(y).errorMessage.value},null,8,["modelValue","error-messages"]),l(xe,{label:"上架",modelValue:t(k).value.value,"onUpdate:modelValue":a[8]||(a[8]=e=>t(k).value.value=e),"error-messages":t(k).errorMessage.value},null,8,["modelValue","error-messages"]),l(we,{label:"說明",modelValue:t(b).value.value,"onUpdate:modelValue":a[9]||(a[9]=e=>t(b).value.value=e),"error-messages":t(b).errorMessage.value},null,8,["modelValue","error-messages"]),l(m,{modelValue:n.value,"onUpdate:modelValue":a[10]||(a[10]=e=>n.value=e),rawModelValue:R.value,"onUpdate:rawModelValue":a[11]||(a[11]=e=>R.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":5,multiple:"","max-size":"1MB",ref_key:"fileAgent",ref:$},null,8,["modelValue","rawModelValue"])]),_:1}),l(ne,null,{default:s(()=>[l(ie),l(B,{color:"red",disabled:t(M),onClick:L},{default:s(()=>[p("取消")]),_:1},8,["disabled"]),l(B,{color:"green",type:"submit",loading:t(M)},{default:s(()=>[p("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{Te as default};
