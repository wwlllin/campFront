import{ae as K,x as r,ar as H,ag as I,as as J,c as l,ai as o,au as O,ac as G,ao as Q,al as T,aM as W,V as X,ah as Y,at as Z,J as F,aj as s,ak as ee,ay as ae,az as le,am as M,aB as te,aE as oe,aw as se,an as re,a6 as ne}from"./index-2a6e0187.js";import{c as ue,a as N,f as ie,u as de,d as S,V as me}from"./index.esm-ffca95e4.js";import{a as ce,V as R}from"./VCol-ba6d81c5.js";import{V as pe}from"./VRow-1fd3371c.js";import{V as ve}from"./VDivider-303ab244.js";import{V as ge,a as Ve,b as fe}from"./VTextarea-6458ace2.js";import"./VDataTable-6273f966.js";import"./VList-581bf7ed.js";const be=re("h1",{class:"text-center"},"貼文管理",-1),Me={__name:"PostsManagement",setup(ye){const{apiAuth:k}=Q(),x=K(),A=r(null),c=r(!1),p=r(""),$=n=>{p.value=n._id,v.value.value=n.title,g.value.value=n.content,V.value.value=n.release,c.value=!0},U=()=>{for(c.value=!1,j();u.value.length>0;)A.value.deleteFileRecord(u.value[0])},z=ue({title:N().required("缺少貼文標題"),content:N().required("缺少貼文內容"),release:ie()}),{handleSubmit:L,isSubmitting:w,resetForm:j}=de({validationSchema:z,initialValues:{title:"",content:"",release:!1}}),v=S("title"),g=S("content"),V=S("release"),u=r([]),_=r([]),q=L(async n=>{var a,d,e;if(!((a=u.value[0])!=null&&a.error)&&!(p.value===""&&u.value.length===0))try{const t=new FormData;for(const i in n)t.append(i,n[i]);if(u.value.length>0)for(const i of u.value)t.append("image",i.file);p.value===""?await k.post("/posts",t):await k.patch("/posts/"+p.value,t),x({text:"編輯成功",showCloseButton:!1,snackbarProps:{timeout:2e3,color:"green",location:"bottom"}}),U(),P()}catch(t){console.log(t);const i=((e=(d=t==null?void 0:t.response)==null?void 0:d.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";x({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}}),h=r(10),f=r([{key:"createdAt",order:"desc"}]),b=r(1),C=r([]),E=[{title:"圖片",align:"center",sortable:!1,key:"image"},{title:"標題",align:"center",sortable:!0,key:"title"},{title:"發佈",align:"center",sortable:!0,key:"release"},{title:"編輯",align:"center",sortable:!1,key:"edit"}],B=r(!0),D=r(0),y=r(""),m=async()=>{var n,a,d,e;B.value=!0;try{const{data:t}=await k.get("/posts",{params:{page:b.value,itemsPerPage:h.value,sortBy:((n=f.value[0])==null?void 0:n.key)||"createdAt",sortOrder:((a=f.value[0])==null?void 0:a.order)==="asc"?1:-1,search:y.value}});C.value.splice(0,C.value.length,...t.result.data),D.value=t.result.total}catch(t){console.log(t);const i=((e=(d=t==null?void 0:t.response)==null?void 0:d.data)==null?void 0:e.message)||"發生錯誤，請稍後再試";x({text:i,showCloseButton:!1,snackbarProps:{timeout:2e3,color:"red",location:"bottom"}})}B.value=!1};m();const P=()=>{b.value=1,m()};return(n,a)=>{const d=H("VueFileAgent");return I(),J(G,null,[l(ce,null,{default:o(()=>[l(pe,null,{default:o(()=>[l(R,{cols:"12"},{default:o(()=>[be]),_:1}),l(ve),l(R,{cols:"12"},{default:o(()=>[l(ge,{"items-per-page":h.value,"onUpdate:itemsPerPage":[a[1]||(a[1]=e=>h.value=e),m],"sort-by":f.value,"onUpdate:sortBy":[a[2]||(a[2]=e=>f.value=e),m],page:b.value,"onUpdate:page":[a[3]||(a[3]=e=>b.value=e),m],items:C.value,headers:E,loading:B.value,"items-length":D.value,search:y.value,hover:""},{top:o(()=>[l(T,{label:"搜尋","append-icon":"mdi-magnify",modelValue:y.value,"onUpdate:modelValue":a[0]||(a[0]=e=>y.value=e),"onClick:append":P,onKeydown:W(P,["enter"])},null,8,["modelValue"])]),"item.image":o(({item:e})=>[l(X,{src:e.image[0],height:"50px"},null,8,["src"])]),"item.release":o(({item:e})=>[e.release?(I(),Y(ne,{key:0,icon:"mdi-check"})):Z("",!0)]),"item.edit":o(({item:e})=>[l(F,{icon:"mdi-pencil",variant:"text",color:"blue",onClick:t=>$(e)},null,8,["onClick"])]),_:2},1032,["items-per-page","sort-by","page","items","loading","items-length","search"])]),_:1})]),_:1})]),_:1}),l(O,{modelValue:c.value,"onUpdate:modelValue":a[9]||(a[9]=e=>c.value=e),persistent:"",width:"500px"},{default:o(()=>[l(me,{disabled:s(w),onSubmit:ee(s(q),["prevent"])},{default:o(()=>[l(ae,null,{default:o(()=>[l(le,null,{default:o(()=>[M("編輯貼文")]),_:1}),l(te,null,{default:o(()=>[l(T,{label:"標題",modelValue:s(v).value.value,"onUpdate:modelValue":a[4]||(a[4]=e=>s(v).value.value=e),"error-messages":s(v).errorMessage.value},null,8,["modelValue","error-messages"]),l(Ve,{label:"發佈",modelValue:s(V).value.value,"onUpdate:modelValue":a[5]||(a[5]=e=>s(V).value.value=e),"error-messages":s(V).errorMessage.value},null,8,["modelValue","error-messages"]),l(fe,{label:"內容",modelValue:s(g).value.value,"onUpdate:modelValue":a[6]||(a[6]=e=>s(g).value.value=e),"error-messages":s(g).errorMessage.value},null,8,["modelValue","error-messages"]),l(d,{modelValue:u.value,"onUpdate:modelValue":a[7]||(a[7]=e=>u.value=e),rawModelValue:_.value,"onUpdate:rawModelValue":a[8]||(a[8]=e=>_.value=e),accept:"image/jpeg,image/png",deletable:"","error-text":{type:"檔案格式不支援",size:"檔案超過 1MB 大小限制"},"help-text":"選擇檔案或拖曳到這裡","max-files":5,multiple:"","max-size":"1MB",ref_key:"fileAgent",ref:A},null,8,["modelValue","rawModelValue"])]),_:1}),l(oe,null,{default:o(()=>[l(se),l(F,{color:"red",disabled:s(w),onClick:U},{default:o(()=>[M("取消")]),_:1},8,["disabled"]),l(F,{color:"green",type:"submit",loading:s(w)},{default:o(()=>[M("送出")]),_:1},8,["loading"])]),_:1})]),_:1})]),_:1},8,["disabled","onSubmit"])]),_:1},8,["modelValue"])],64)}}};export{Me as default};
